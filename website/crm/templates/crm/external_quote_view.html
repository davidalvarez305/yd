{% extends 'crm/base.html' %}
{% load static %}
{% block content %}
<div id="proposal" class="mx-auto flex flex-col overflow-hidden rounded-lg bg-white shadow-sm xl:max-w-4xl dark:bg-gray-800 dark:text-gray-100 print:shadow-none">
    <div class="grow p-5 print:p-0">
        <div class="mx-auto lg:w-10/12 print:w-full">
            <div
                class="flex items-center justify-between border-b border-gray-100 py-10 dark:border-gray-700/50 print:pt-0">
                <h3 class="font-semibold">{{ company_name }} Quote <br>
                {{ quote.event_date }}</h3>
            </div>

            <div class="grid grid-cols-1 gap-4 py-10 md:grid-cols-2 lg:gap-8 print:grid-cols-2">
                <!-- Company Info -->
                <div>
                    <div class="mb-1 text-lg font-semibold">{{ company_name }}</div>
                    <address class="text-sm text-gray-500 dark:text-gray-400">
                        7321 Pine Valley Dr<br />
                        Hialeah, FL<br />
                        33015<br />
                        {{ phone_number }}
                    </address>
                </div>
                <!-- END Company Info -->

                <!-- Client Info -->
                <div class="md:text-right print:text-right">
                    <div class="mb-1 text-lg font-semibold">{{ quote.lead.full_name }}</div>
                    <address class="text-sm text-gray-500 dark:text-gray-400">
                        {{ quote.event_date }}<br />
                        {{ quote.lead.formatted_number }}<br />
                    </address>
                </div>
                <!-- END Client Info -->
            </div>

            <div class="py-8 text-center">
                <h3 class="font-semibold">{{ company_name }} Offers:</h3>
            </div>
            <!-- Responsive Table Container -->
            <div
                class="min-w-full overflow-x-auto rounded border border-gray-100 bg-white dark:border-gray-700 dark:bg-gray-800">
                <table class="min-w-full whitespace-nowrap align-middle text-sm">
                    <!-- Table Header -->
                    <thead>
                        <tr class="border-b border-gray-100 dark:border-gray-700/50">
                            <th
                                class="bg-gray-100/75 px-3 py-4 text-left font-semibold text-gray-900 dark:bg-gray-700/25 dark:text-gray-50">
                                Item
                            </th>
                            <th
                                class="bg-gray-100/75 px-3 py-4 text-right font-semibold text-gray-900 dark:bg-gray-700/25 dark:text-gray-50">
                                Qty.
                            </th>
                            <th
                                class="bg-gray-100/75 px-3 py-4 text-right font-semibold text-gray-900 dark:bg-gray-700/25 dark:text-gray-50">
                                Unit Rate
                            </th>
                            <th
                                class="bg-gray-100/75 px-3 py-4 text-right font-semibold text-gray-900 dark:bg-gray-700/25 dark:text-gray-50">
                                Total
                            </th>
                        </tr>
                    </thead>
                    <!-- END Table Header -->

                    <!-- Table Body -->
                    <tbody>
                        {% for quote_service in quote.quote_services.all %}
                        <tr class="border-b border-gray-100 dark:border-gray-700/50">
                            <td class="p-3">
                                <p class="mb-1 font-semibold">{{ quote_service.service }}</p>
                            </td>
                            <td class="p-3 text-right">{{ quote_service.units }}</td>
                            <td class="p-3 text-right">${{ quote_service.price_per_unit|floatformat:2 }}</td>
                            <td class="p-3 text-right">${{ quote_service.total|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                        {% for invoice in quote.invoices.all %}
                            {% if invoice.date_paid %}
                            <tr class="border-b border-gray-100 dark:border-gray-700/50">
                                <td class="p-3">
                                    <p class="mb-1 font-semibold">{{ invoice.invoice_type.type }} PAID</p>
                                </td>
                                <td colspan="3" class="p-3 text-right">-${{ invoice.amount }}</td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                        <tr>
                            <td colspan="3" class="bg-gray-50 p-3 text-right font-bold uppercase dark:bg-gray-900/50">Total Due</td>
                            <td class="bg-gray-50 p-3 text-right font-semibold dark:bg-gray-900/50">${{ quote.total_due|floatformat:2 }}</td>
                        </tr>
                    </tbody>
                    <!-- END Table Body -->
                </table>
            </div>
            <!-- END Responsive Table Container -->

            <!-- Terms & Conditions -->
            <div class="leading-relaxed max-w-3xl mx-auto pb-4 space-y-4 text-sm font-medium">
                <h2 class="text-center text-xl pt-4">Terms & Conditions</h3>
                <h3 class="text-lg">Credit Card Authorization</h3>
                <p>By submitting your credit card information, you expressly authorize {{ company_name }} to charge your credit card, for all services rendered, rental items provided, deposits, applicable taxes, and any other amounts due under these Terms & Conditions.
                This authorization includes permission to store your payment method securely for future use and to process additional charges after the event date if necessary, including but not limited to charges for late delivery or pickup, extended rental periods, cleaning fees, broken, lost, or damaged items, replacement costs, and any other fees resulting from delays or violations of these Terms & Conditions.
                You represent and warrant that you are the authorized cardholder or have authorization to use the card provided and that sufficient funds are available.
                You agree not to dispute charges that are consistent with this authorization, and you acknowledge that this authorization shall remain in effect until all obligations to {{ company_name }} have been satisfied in full.</p>
                
                {% if has_rental and not has_setup and not has_bartending %}
                <h3 class="text-lg">Delivery & Setup Disclaimer</h3>
                <p>
                Customer acknowledges and agrees that this order includes <strong>delivery and drop-off only</strong>.
                <strong>Setup, assembly, arrangement, or placement of rental items is NOT included</strong> unless
                explicitly listed as a paid service on this invoice.
                </p>
                <p>
                Rental items will be delivered in a consolidated drop-off condition at the designated delivery
                location. Customer is solely responsible for all setup, assembly, positioning, and arrangement
                of items after delivery.
                </p>
                <p>
                Any request for setup, assembly, or assistance at the time of delivery that is not included in
                this agreement may be accommodated solely at {{ company_name|default:"[Company Name]" }}’s discretion
                and will result in <strong>additional charges of $50 per hour, billed in 15-minute increments</strong>,
                with a one-hour minimum.
                </p>
                <p>
                Customer authorizes {{ company_name|default:"[Company Name]" }} to charge the payment method on file
                for any additional setup labor performed at the Customer’s request at the time of delivery.
                </p>
                {% endif %}

                {% if has_bartending %}
                <h3 class="text-lg">Scope of Work</h3>
                <p>
                Customer acknowledges and agrees that bartender(s) are retained exclusively for beverage preparation and service.
                Bartender(s) shall not be required, expected, or permitted to perform any duties outside this scope, including but
                not limited to cleaning, setup, teardown, lifting, moving equipment, or handling items not directly related to the
                bar or designated bar service area. Any request for services outside this scope is expressly unauthorized and, if
                made, is done at the Customer’s sole risk and responsibility, and shall not create any duty, liability, or obligation
                on the part of the bartender(s) or {{ company_name|default:"[Company Name]" }}.
                </p>
                <h3 class="text-lg">Extension of Service</h3>
                <p>
                Any payment, gratuity, or compensation provided directly to the bartender(s), including but not limited to
                <strong>Zelle</strong>, <strong>CashApp</strong>, <strong>cash</strong>, or any other informal or third-party payment method,
                <strong>does not constitute payment for an extension of service, additional time, or additional services</strong>
                and shall not be credited toward this invoice. <strong>All extensions of service, additional hours, or added services
                must be approved by and paid directly to {{ company_name|default:"[Company Name]" }} through this invoice.</strong>
                </p>
                <h3 class="text-lg">Safety, Conduct & Right to Terminate Service</h3>
                <p>
                Customer acknowledges and agrees that the safety, dignity, and well-being of the bartender(s) is paramount.
                Bartender(s) reserve the absolute right, at their sole discretion, to immediately refuse service to any guest and/or
                terminate services and leave the event premises without notice if they experience or observe harassment, intimidation,
                threatening behavior, excessive intoxication, inappropriate conduct, unsafe conditions, or any behavior that, in the
                bartender’s reasonable judgment, creates an unsafe or hostile environment.
                </p>
                <p>
                In such circumstances, termination of service shall not constitute a breach of contract, and no refunds, credits, or
                reductions shall be issued. Customer assumes full responsibility for the conduct of all guests and agrees to promptly
                address and remedy any behavior upon request. {{ company_name|default:"[Company Name]" }} and its bartender(s) shall
                have no liability arising from the suspension or termination of services due to safety or conduct concerns.
                </p>
                {% endif %}
                <h3 class="text-lg">Refund Policy</h3>
                <p>
                In the event of cancellation by the Customer for any reason, a full refund of all payments received will be available
                only if written notice of cancellation is received on or before <strong>{{ payment_due_date }}</strong>.
                Cancellations received after this date shall result in <strong>all payments being non-refundable</strong>, including but
                not limited to deposits, rental fees, service fees, and any other amounts paid, regardless of whether the event takes
                place.
                </p>
                <p>
                Refunds will not be issued for partial use of services, early termination, no-shows, weather conditions,
                guest behavior, venue-related issues, or any circumstances within the Customer’s control. Once services, delivery,
                setup, or staffing have commenced, all charges are deemed fully earned.
                </p>
                <p>
                In the event that {{ company_name|default:"[Company Name]" }} must cancel the event due to unforeseen circumstances,
                including but not limited to equipment failure, illness, staffing issues, safety concerns, or force majeure events
                (such as acts of God, severe weather, government orders, or events beyond reasonable control), the Customer’s sole
                remedy shall be a refund of all payments received. No additional compensation, damages, or liability shall be owed.
                Reasonable notice will be provided when practicable, and a minimum of two (2) weeks’ notice will be given when
                possible.
                </p>
                <p>
                If services are suspended or terminated due to safety concerns, harassment, excessive intoxication, unsafe conditions,
                or violations of these Terms & Conditions by the Customer or guests, such termination shall not constitute a
                cancellation by {{ company_name|default:"[Company Name]" }} and <strong>no refunds, credits, or chargebacks shall be
                issued</strong>.
                </p>
                <p>
                All approved refunds will be processed to the original form of payment only and may take 5–10 business days to appear,
                depending on the payment processor.
                </p>
                {% if has_rental %}
                <h3 class="text-lg">Rental Items, Damage, Delays & Accessibility</h3>
                <p>
                Customer assumes full responsibility for all rental items from the time of delivery until pickup is completed.
                Any rental item that is damaged, broken, lost, stolen, excessively soiled, or rendered unusable for any reason
                while in the Customer’s possession shall be charged at <strong>full retail replacement value</strong> per item,
                without depreciation, regardless of whether the damage was caused by the Customer, guests, vendors, or any
                third parties.
                </p>
                <p>
                Customer agrees to ensure that a responsible adult is present at the delivery and pickup times provided to allow
                for immediate access to the rental items. Failure to have a representative present, provide timely access, or
                otherwise facilitate delivery or pickup may result in delay fees and additional charges as outlined below.
                </p>
                <p>
                Delays during delivery or pickup resulting in driver wait time shall incur a <strong>$50 fee for the first
                thirty (30) minutes</strong> of delay and an additional <strong>$25 fee for every fifteen (15) minutes thereafter</strong>.
                Delays include, but are not limited to: inability to access the location or rental items; locked gates, doors, or
                elevators; incorrect or incomplete delivery address or instructions; lack of parking or loading access; Customer
                or representative not being present; venue restrictions not disclosed in advance; or any other circumstance
                outside the control of {{ company_name|default:"[Company Name]" }} or its drivers.
                </p>
                <p>
                Customer agrees that all rental items must be returned in the <strong>same general organization and condition</strong>
                as delivered, consolidated in a single, easily accessible location approved at delivery. Items that are scattered,
                disassembled, relocated, obstructed, or otherwise not readily accessible for pickup may result in additional labor
                charges. Failure to properly organize and make items easily accessible shall constitute an additional charge equal
                to the original delivery fee, in addition to any applicable delay or labor fees.
                </p>
                <p>
                Customer authorizes {{ company_name|default:"[Company Name]" }} to charge the payment method on file for any damage,
                replacement, delay, labor, or additional fees incurred as a result of the above, in accordance with these Terms &
                Conditions.
                </p>
                <h3 class="text-lg">Customer Pick-Ups & Returns</h3>
                <p>
                Unless otherwise agreed in writing, Customers who elect to pick up rental items are responsible for returning all
                rented items to {{ company_name|default:"[Company Name]" }} within <strong>seventy-two (72) business hours (Monday
                through Friday, excluding holidays)</strong> following the conclusion of the rental period. Failure to return all
                items within this timeframe shall result in the items being deemed <strong>lost or stolen</strong>, and Customer
                authorizes {{ company_name|default:"[Company Name]" }} to charge the payment method on file the <strong>full retail
                replacement value</strong> of any unreturned items, without further notice.
                </p>
                <p>
                If Customer has scheduled a company pickup and {{ company_name|default:"[Company Name]" }} is unable to complete the
                pickup due to circumstances outside of its control, including but not limited to lack of access, incorrect address,
                Customer or representative not being present, items not being consolidated or accessible, venue restrictions, or
                any other delay or obstruction caused by the Customer or third parties, the Customer shall remain fully responsible
                for the rental items.
                </p>
                <p>
                In such cases, Customer agrees either to return the rental items at their own expense within the required return
                period or to incur an additional charge equal to the original <strong>delivery and labor fees</strong> for each
                subsequent pickup attempt. Repeated failed pickup attempts shall not extend the return deadline or waive any
                applicable damage, loss, or replacement charges.
                </p>
                <p>
                Customer acknowledges that responsibility for the rental items continues until items are physically returned to
                and accepted by {{ company_name|default:"[Company Name]" }}. Customer authorizes all applicable charges related to
                failed pickups, additional labor, transportation, loss, or replacement to be processed to the payment method on
                file in accordance with these Terms & Conditions.
                </p>
                {% endif %}
                <p class="py-4 text-lg">
                    By paying the deposit, you agree to the terms & conditions laid out in this service agreement.
                </p>
            </div>
            <!-- END Terms & Conditions -->

            <!-- Buttons -->
            <div class="w-full flex flex-col sm:flex-row justify-center align-center py-4 gap-4">
                {% for invoice in quote.invoices.all %}
                    {% with lead_id=quote.lead.pk invoice_id=invoice.pk %}
                        {% if quote.total_due > 0.00 %}
                            {% if not quote.is_deposit_paid %}
                                {% if not quote.is_within_week and invoice.invoice_type.type == 'DEPOSIT' and invoice.amount > 0.00 %}
                                <button data-invoice-id="{{ invoice.pk }}" type="button" class="initialPaymentButton w-full inline-flex items-center justify-center gap-2 rounded-lg border border-primary-700 bg-primary-700 px-3 py-2 text-md font-semibold leading-5 text-white hover:border-primary-600 hover:bg-primary-600 hover:text-white focus:ring focus:ring-primary-400/50 active:border-primary-700 active:bg-primary-700 dark:focus:ring-primary-400/90">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hi-outline hi-lock-closed inline-block size-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z"/>
                                    </svg>
                                    <span>Reserve Date For ${{ invoice.amount }}</span>
                                </button>
                                {% endif %}
                                {% if invoice.date_paid is None and invoice.invoice_type.type == 'FULL' and invoice.amount > 0.00 %}
                                <button data-invoice-id="{{ invoice.pk }}" type="button" class="initialPaymentButton w-full inline-flex items-center justify-center gap-2 rounded-lg border border-emerald-700 bg-emerald-700 px-3 py-2 text-md font-semibold leading-5 text-white hover:border-emerald-600 hover:bg-emerald-600 hover:text-white focus:ring focus:ring-emerald-400/50 active:border-emerald-700 active:bg-emerald-700 dark:focus:ring-emerald-400/90">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hi-outline hi-credit-card inline-block size-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z"/>
                                    </svg>
                                    <span>Pay In Full For ${{ invoice.amount }}</span>
                                </button>
                                {% endif %}
                            {% elif invoice.date_paid is None and invoice.invoice_type.type == 'REMAINING' and invoice.amount > 0.00 %}
                                <form hx-post="{% url 'initiate_checkout' %}?lead_id={{ quote.lead.pk }}&invoice_id={{ invoice.pk }}"
                                    hx-target-error="#alertModal" data-loading-target="#remainingAmountButtonLoader"
                                >
                                    {% csrf_token %}    
                                    <button type="submit"
                                        class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-primary-700 bg-primary-700 px-3 py-2 text-md font-semibold leading-5 text-white hover:border-primary-600 hover:bg-primary-600 hover:text-white focus:ring focus:ring-primary-400/50 active:border-primary-700 active:bg-primary-700 dark:focus:ring-primary-400/90">
                                        <svg id="remainingAmountButtonLoader" class="hidden lucide lucide-loader-circle inline-block size-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                                        </svg>
                                        <span>Pay Remaining Amount For ${{ invoice.amount }}</span>
                                    </button>
                                </form>
                            {% elif invoice.invoice_type.type == 'EXTEND' and invoice.date_paid is None and invoice.amount > 0.00 %}
                                <form hx-post="{% url 'initiate_checkout' %}?lead_id={{ quote.lead.pk }}&invoice_id={{ invoice.pk }}"
                                    hx-target-error="#alertModal" data-loading-target="#extendAmountButtonLoader"
                                >
                                    {% csrf_token %}    
                                    <button type="submit"
                                        class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-primary-700 bg-primary-700 px-3 py-2 text-md font-semibold leading-5 text-white hover:border-primary-600 hover:bg-primary-600 hover:text-white focus:ring focus:ring-primary-400/50 active:border-primary-700 active:bg-primary-700 dark:focus:ring-primary-400/90">
                                        <svg id="extendAmountButtonLoader" class="hidden lucide lucide-loader-circle inline-block size-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                                        </svg>
                                        <span>Pay Extension Amount For ${{ invoice.amount }}</span>
                                    </button>
                                </form>
                            {% endif %}
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </div>
            <!-- END Buttons -->
        </div>
    </div>
    
    {% if quote.changes.count > 0 %}
    <table class="min-w-full align-middle text-sm whitespace-nowrap">
        <thead>
            <tr class="border-b border-gray-100 dark:border-gray-700/50">
                <th class="bg-gray-100/75 px-3 py-4 text-center font-semibold text-gray-900 dark:bg-gray-700/25 dark:text-gray-50">Change Log</th>
            </tr>
        </thead>

        <tbody>
            {% for change in quote.changes.all %}
            <tr class="border-b border-gray-100 dark:border-gray-700/50">
                <td class="p-3">
                    <p class="font-medium text-center">{{ change }}</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<script>
    const initialPaymentButton = document.querySelectorAll('.initialPaymentButton');

    function handleInitiatePaymentFlow(invoiceId) {
        const serviceAgreementModal = modalHelper.get('serviceAgreementModal');
        serviceAgreementModal.open();
        serviceAgreementModal.setOnClose(() => initiateCheckout(invoiceId));
    }

    const isDebug = "{{ debug }}" === "True";

    if (isDebug) {
        initialPaymentButton.forEach(btn => {
            btn.addEventListener('click', () => handleInitiatePaymentFlow(btn.dataset.invoiceId));
        });
    } else {
        initialPaymentButton.forEach(btn => {
            btn.addEventListener('click', () => initiateCheckout(btn.dataset.invoiceId));
        });
    }

    function initiateCheckout(invoiceId) {
        const button = document.querySelector(`.initialPaymentButton[data-invoice-id="${invoiceId}"]`);

        if (button) {
            button.disabled = true;
            button.textContent = 'Loading...';
            button.classList.add('opacity-60', 'cursor-not-allowed');
        }

        const url = `{% url 'initiate_checkout' %}?lead_id={{ quote.lead.pk }}&invoice_id=${invoiceId}`;
        
        htmx.ajax('POST', url, {
            swap: 'outerHTML',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            error: function (err) {
                loader.classList.add('hidden');
                htmx.trigger('#alertModal', 'showAlert', { message: 'Payment initiation failed.' });
            },
            finally: function () {
                loader.classList.add('hidden');
            }
        });
    }
</script>
{% endblock %}